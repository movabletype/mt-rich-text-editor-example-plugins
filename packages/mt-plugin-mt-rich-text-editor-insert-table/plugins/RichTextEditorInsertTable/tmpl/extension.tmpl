<mt:setvarblock name="js_include" append="1">
  <!-- <__trans_section component="richtexteditorinserttable"> -->
  <template id="rich-text-editor-insert-table-icon">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="icon icon-tabler icons-tabler-outline icon-tabler-file-type-csv"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M14 3v4a1 1 0 0 0 1 1h4" />
      <path d="M5 12v-7a2 2 0 0 1 2 -2h7l5 5v4" />
      <path d="M7 16.5a1.5 1.5 0 0 0 -3 0v3a1.5 1.5 0 0 0 3 0" />
      <path
        d="M10 20.25c0 .414 .336 .75 .75 .75h1.25a1 1 0 0 0 1 -1v-1a1 1 0 0 0 -1 -1h-1a1 1 0 0 1 -1 -1v-1a1 1 0 0 1 1 -1h1.25a.75 .75 0 0 1 .75 .75"
      />
      <path d="M16 15l2 6l2 -6" />
    </svg>
  </template>
  <dialog id="rich-text-editor-insert-table-dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="file" class="mb-2 d-block">
                <__trans phrase="CSV File" />
              </label>
              <input type="file" class="form-control-file" accept=".csv" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" data-secondary class="btn btn-secondary">
            <__trans phrase="Cancel" />
          </button>
          <button type="button" data-primary class="btn btn-primary">
            <__trans phrase="Insert" />
          </button>
        </div>
      </div>
    </div>
  </dialog>
  <script type="module">
    class RichTextEditorInsertTable extends MTRichTextEditor.Component
      .ToolbarItemElement {
      constructor() {
        super();
        const button = document.createElement("button");
        button.title = "<__trans phrase='Insert table'>";
        button.innerHTML = document.querySelector(
          "#rich-text-editor-insert-table-icon"
        ).innerHTML;
        this.shadowRoot.appendChild(button);
      }

      connectedCallback() {
        super.connectedCallback();
        const dialog = this.initDialog();
        this.addEventListener("click", () => {
          dialog.showModal();
        });
      }

      initDialog() {
        const dialog = document
          .querySelector("#rich-text-editor-insert-table-dialog")
          .cloneNode(true);
        document.body.appendChild(dialog);

        dialog
          .querySelector("button[data-secondary]")
          .addEventListener("click", (ev) => {
            ev.preventDefault();
            dialog.close();
          });

        dialog
          .querySelector("button[data-primary]")
          .addEventListener("click", (ev) => {
            ev.preventDefault();
            const file = dialog.querySelector("input[type='file']").files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
              const table = document.createElement("table");
              const tbody = document.createElement("tbody");
              table.appendChild(tbody);
              const text = ev.target.result;
              text.split("\n").forEach((line) => {
                const row = document.createElement("tr");
                line.split(",").forEach((cell) => {
                  const td = document.createElement("td");
                  const paragraph = document.createElement("p");
                  paragraph.textContent = cell;
                  td.appendChild(paragraph);
                  row.appendChild(td);
                });
                tbody.appendChild(row);
              });
              this.tiptap.commands.insertContent(table.outerHTML);
            };
            reader.readAsText(file);
            dialog.querySelector("form").reset();
            dialog.close();
          });
        return dialog;
      }
    }
    customElements.define(
      "mt-rich-text-editor-toolbar-item-inserttable",
      RichTextEditorInsertTable
    );
  </script>
  <!-- </__trans_section> -->
</mt:setvarblock>
